<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../api-url-data-model/api-url-data-model.html">
<link rel="import" href="../api-url-editor/api-url-editor.html">
<link rel="import" href="../api-url-params-editor/api-url-params-editor.html">
<link rel="import" href="../authorization-panel/authorization-panel.html">
<link rel="import" href="../api-headers-editor/api-headers-editor.html">
<link rel="import" href="../api-body-editor/api-body-editor.html">
<link rel="import" href="../raml-aware/raml-aware.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../api-form-mixin/api-form-styles.html">
<link rel="import" href="../uuid-generator/uuid-generator.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<dom-module id="api-request-editor">
  <template>
    <style include="api-form-styles">
    :host {
      display: block;
      @apply --arc-font-body1;
      @apply --api-request-editor;
    }

    .content {
      height: 100%;
      @apply --layout-vertical;
      @apply --api-request-editor-container;
    }

    [hidden] {
      display: none !important;
    }

    .panel-warning {
      width: 16px;
      height: 16px;
      margin-left: 4px;
      color: var(--warning-primary-color, #FF7043);
    }

    .url-invalid-info {
      @apply --arc-font-body1;
      color: var(--error-color);
    }

    paper-spinner {
      margin-right: 8px;
    }

    iron-pages > * {
      border: 1px var(--api-request-editor-editors-border-color, transparent) solid;
      min-height: 120px;
    }

    .action-bar {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
      @apply --layout-center;
      margin-top: 8px;
    }

    .send-button {
      background-color: var(--primary-button-background-color, var(--accent-color));
      color: var(--primary-button-color, #fff);
      @apply --action-button;
    }

    .send-button:hover {
      background-color: var(--primary-button-hover-background-color, var(--accent-color));
      color: var(--primary-button-hover-color, #fff);
      @apply --action-button-hover;
    }

    .send-button[disabled] {
      background-color: var(--primary-button-disabled-background-color, rgb(234, 234, 234));
      color: var(--primary-button-disabled-color, #a8a8a8);
      @apply --action-button-disabled;
    }

    .url-editor {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    api-url-editor {
      @apply --layout-flex;
    }

    :host([narrow]) .content {
      @apply --layout-vertical;
      @apply --api-request-editor-container-narrow;
    }

    :host([narrow]) api-url-editor {
      width: auto;
    }
    </style>
    <template is="dom-if" if="[[aware]]">
      <raml-aware raml="{{amfModel}}" scope="[[aware]]"></raml-aware>
    </template>
    <api-url-data-model
      aware="[[aware]]"
      web-api="[[amfModel]]"
      endpoint-path="{{endpointPath}}"
      api-base-uri="{{apiBaseUri}}"
      selected="[[selectedAmfId]]"
      path-model="{{pathModel}}"
      query-model="{{queryModel}}"></api-url-data-model>
    <div class="content">
      <div class="url-editor" hidden$="[[noUrlEditor]]">
        <api-url-editor
          required
          auto-validate
          invalid="{{urlInvalid}}"
          base-uri="[[_computeFinalBaseUri(apiBaseUri,baseUri)]]"
          endpoint-path="[[endpointPath]]"
          query-model="{{queryModel}}"
          path-model="{{pathModel}}"
          events-target="[[eventsTarget]]"
          value="{{url}}"></api-url-editor>
      </div>
      <paper-tabs selected="{{selectedTab}}">
        <paper-tab hidden$="[[authNotRequired]]">
          Authorization
          <iron-icon icon="arc:warning" class="panel-warning" hidden$="[[authValid]]" title="Fill up missing auth data"></iron-icon>
        </paper-tab>
        <paper-tab>Parameters</paper-tab>
        <paper-tab>Headers</paper-tab>
        <paper-tab hidden$="[[!isPayloadRequest]]">Body</paper-tab>
      </paper-tabs>
      <iron-pages selected="{{selectedTab}}">
        <authorization-panel events-target="[[eventsTarget]]" hidden$="[[authNotRequired]]" secured-by="[[securedBy]]" redirect-uri="[[redirectUri]]" auth-required="{{authRequired}}" auth-valid="{{authValid}}"></authorization-panel>
        <api-url-params-editor uri-model="{{pathModel}}" query-model="{{queryModel}}" narrow="[[narrow]]" allow-custom="[[allowCustom]]"></api-url-params-editor>
        <api-headers-editor events-target="[[eventsTarget]]" amf-headers="[[apiHeaders]]" narrow="[[narrow]]" content-type="{{contentType}}" is-payload="[[isPayloadRequest]]" value="{{headers}}" narrow="[[narrow]]" allow-custom="[[allowCustom]]" allow-disable-params="[[allowDisableParams]]" allow-hide-optional="[[allowHideOptional]]"></api-headers-editor>
        <api-body-editor events-target="[[eventsTarget]]" amf-model="[[apiPayload]]" narrow="[[narrow]]" hidden$="[[!isPayloadRequest]]" content-type="{{contentType}}" value="{{payload}}" narrow="[[narrow]]" allow-custom="[[allowCustom]]" allow-disable-params="[[allowDisableParams]]" allow-hide-optional="[[allowHideOptional]]"></api-body-editor>
      </iron-pages>
      <div class="action-bar">
        <paper-spinner alt="Loading contacts list" active="[[loadingRequest]]"></paper-spinner>
        <span class="url-invalid-info" hidden$="[[!urlInvalid]]">Request URL is invalid.</span>
        <template is="dom-if" if="[[authValid]]">
          <paper-button raised class="send-button" on-tap="execute" hidden$="[[loadingRequest]]" disabled="[[urlInvalid]]">Send</paper-button>
          <paper-button raised class="send-button" on-tap="_abortRequest" hidden$="[[!loadingRequest]]">Abort</paper-button>
        </template>
        <template is="dom-if" if="[[!authValid]]">
          <paper-button class="send-button" on-tap="authAndExecute" disabled="[[urlInvalid]]">Authorize and send</paper-button>
        </template>
      </div>
    </div>
    <paper-toast text="Authorization for this endpoint is required" id="authFormError" horizontal-align="right" horizontal-offset="12"></paper-toast>
    <uuid-generator id="uuid"></uuid-generator>
  </template>
  <script>
  (function() {
    const RAML_VOC = 'http://raml.org/vocabularies/';
    const VOC_DOC = RAML_VOC + 'document#';
    const VOC_HTTP = RAML_VOC+ 'http#';
    const HYD_CORE = 'http://www.w3.org/ns/hydra/core#';
    /**
     * `api-request-editor`
     * A request editor that builds the UI based on [AMF](https://github.com/mulesoft/amf/) model.
     *
     * The fors are generated automatically based on endponit's definition.
     *
     * Set AMF json/ld model to `amfModel` property. It accepts the generated
     * API specification model (first element is a shape of
     * `http://raml.org/vocabularies/document#Document` type).
     *
     * To build request editor view for an endpoint, set `selectedAmfId`
     * property to an id of an operation that is defined in the spec. The
     * element looks up for the definition and applied to the editors.
     *
     * This element is to replace deprecated `advanced-rest-client/raml-request-editor`.
     *
     * ## Changes in version 2
     *
     * - XHR element is not included in the element. Use `advanced-rest-client/xhr-simple-request` in your application or handle `api-request` custom event to make a request
     * - The element does not include any polyfills
     * - `redirectUrl` is now `redirectUri`
     * - `api-console-request` event is now `api-request` event
     * - `api-console-response` event is now `api-response` event
     * - Added more details to `api-request` custom event (compering to `api-console-request`)
     * - The user is able to enable/disable query parameters and headers. Set `allow-disable-params` attribute to enable this behavior.
     * - The user is able to add custom query parameters or headers.  Set `allow-custom` attribute to enable this behavior.
     * - From authorization panel changes:
     *  - `auth-settings-changed` custom event is stopped from bubbling. Listen for `authorization-settings-changed` event instead.
     * - From auth-method-oauth2 changes:
     *  - Added `deliveryMethod` and `deliveryName` properties to the `detail.setting` object.
     * - From auth-method-oauth1 changes:
     *  - Crypto library is no longer included into the element. Use `advanced-rest-client/cryptojs-lib` component to include the library if your project doesn't use crypto libraries already.
     *
     * ## api-request event
     *
     * Dispatched when "send" button is pressed by the user and the element passes
     * validation.
     * The application should handle the event and make the connection to remote
     * server using passed parameters. When the response is ready the application
     * must inform the elements about the response by dispatching `api-response`
     * custom event.
     *
     * Note that if you set `eventsTarget` property the event must be dispatched
     * at most on `eventsTarget` node (or any child node).
     *
     * API components has `advanced-rest-client/xhr-simple-request` element to
     * handle `api-request` and `abort-api-request` events and to use XHR to
     * make the connection. Note that it may not always work if the API does not
     * allows CORS.
     *
     * The api-request event has the following properties:
     *
     * - url (`String`) - Endpoint full and final url. Note that if the API does
     * not specify base uri and `baseUri` property is not set then the `url`
     * can be relative url to the resource.
     * - method (`String`) - HTTP method. User cannot change this value, it is encoded in the endpoint description
     * - headers (`String`) - valid HTTP headers string
     * - payload (`String|FormData|File|Blob|undefined`) - Request body
     * - id (`String`) - A unique request identifier. This ID has to be reported back by `api-response` event. It is generated when `execute()` function is called.
     * - auth (`Object|undefined`) - Current authorization settings received from the authorization panel.
     * In case of basic, oauth 1 and oauth 2 authorizations, the token is applied to the
     * headers or query parameters so no action is required.
     * - authType (`String|undefined`) - Name of the authorization methods. One of `advanced-rest-client/auth-methods`.
     * - queryModel (`Array<Object>`) - Query parameters data view model.
     * - pathModel (`Array<Object>`) - URI parameters data view model
     * - headersModel (`Array<Object>`) - Headers data view model
     *
     * Do not change `queryModel`, `pathModel` and `headersModel` as it would make it out of sync with the application
     * and any change won't be reflected in the editor. In future release this may be read only object.
     *
     * ## abort-api-request event
     *
     * The event is dispatched when the user press `abort` button.
     * The transport must send `api-response` custom event with error message so the state of the UI is updated.
     *
     * The event contains the following properties:
     *
     * - url (`String`) The request URL. Can be empty string. Also, it may be different URL that the one used to send the request if the user changed it in between. Use the `id` property to compare requests.
     * - id (`String`)  Generated UUID of the request with `api-request` event.
     *
     * ## api-response event
     *
     * This element does not act on this event. See `api-request-panel` documentation for more information.
     *
     * ## Styling
     *
     * `<api-request-editor>` provides the following custom properties and mixins for styling:
     *
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--api-request-editor` | Mixin applied to this elment | `{}`
     * `--api-request-editor-container` | Mixin applied to the main container | `{}`
     * `--warning-primary-color` | Theme property, warning primary color | `#FF7043`
     * `--arc-font-body1` | Theme mixin, default font definition | `{}`
     * `--error-color` | Theme variable, error color.  | ``
     * `--api-request-editor-editors-border-color | Border color of editors in tabs | `transparent`
     * `--primary-button-background-color` | Theme property, background color of the primary action button. Applied to "send" and "abort" buttons | `--accent-color`
     * `--primary-button-color` | Theme property, font color of the primary action button. Applied to "send" and "abort" buttons  | `#fff`
     * `--action-button` | Theme mixin, applied to "send" and "abort" buttons | `{}`
     * `--primary-button-hover-background-color` | Theme property, background color of the primary action button when hovering. Applied to "send" and "abort" buttons | `--accent-color`
     * `--primary-button-hover-color` | Theme property, font color of the primary action button when hovering. Applied to "send" and "abort" buttons  | `#fff`
     * `--action-button-hover` | Theme mixin, applied to "send" and "abort" buttons when hovering | `{}`
     * `--primary-button-disabled-background-color` | Theme property, background color of the primary action button when disabled. Applied to "send" and "abort" buttons | `--accent-color`
     * `--primary-button-disabled-color` | Theme property, font color of the primary action button when disabled. Applied to "send" and "abort" buttons  | `#fff`
     * `--action-button-disabled` | Theme mixin, applied to "send" and "abort" buttons when disabled | `{}`
     * `--api-request-editor-container-narrow` | Mixin applied to the main container when `narrow` property is set. | `{}`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     * @appliesMixin ArcBehaviors.EventsTargetBehavior
     */
    class ApiRequestEditor extends ArcBehaviors.EventsTargetBehavior(Polymer.Element) {
      static get is() { return 'api-request-editor'; }
      static get properties() {
        return {
          /**
           * `raml-aware` scope property to use.
           */
          aware: String,
          /**
           * AMF HTTP method (operation in AMF vocabulary) ID.
           */
          selectedAmfId: String,
          /**
           * AMF API model.
           * The element extracts method definition from passed model
           * and by using `selectedAmfId`.
           */
          amfModel: Object,
          /**
           * Computed method declaration in the AMF model.
           */
          _methodModel: {
            type: Object,
            computed: '_computeMethodModel(amfModel, selectedAmfId)'
          },
          /**
           * Hides the URL editor from the view.
           * The editor is still in the DOM and the `urlInvalid` property still will be set.
           */
          noUrlEditor: Boolean,
          /**
           * A base URI for the API. To be set if RAML spec is missing `baseUri`
           * declaration and this produces invalid URL input. This information
           * is passed to the URL editor that prefixes the URL with `baseUri` value
           * if passed URL is a relative URL.
           */
          baseUri: String,
          /**
           * Computed from AMF model for the metod HTTP method name.
           *
           * @type {String}
           */
          httpMethod: {
            type: Boolean,
            value: false,
            computed: '_computeHttpMethod(_methodModel)',
            notify: true
          },
          /**
           * Headers for the request.
           *
           * @type {String|undefined}
           */
          headers: {
            type: String,
            notify: true
          },
          /**
           * Body for the request. The type of the body depends on
           * defined in the API media type.
           *
           * @type {String|FormData|File}
           */
          payload: {
            type: String,
            notify: true
          },
          /**
           * Final request URL including settings like `baseUri`, AMF
           * model settings and user provided parameters.
           * This value is always compoted by `api-url-editor` even if it's
           * hidden from the view.
           */
          url: {
            type: String,
            notify: true
          },
          /**
           * Selected request tab.
           */
          selectedTab: {
            type: Number,
            value: 0,
            notify: true,
            observer: '_selectedTabChanged'
          },
          /**
           * Current content type.
           *
           * @type {String|undefined}
           */
          contentType: {
            type: String,
            notify: true
          },
          /**
           * Computed value of security scheme from selected method.
           *
           * @type {Array<Object>}
           */
          securedBy: {
            type: Array,
            computed: '_computeSecuredBy(_methodModel)'
          },
          /**
           * Computed list of headers in the AMF model
           *
           * @type {Array<Object>}
           */
          apiHeaders: {
            type: Array,
            computed: '_computeHeaders(_methodModel)'
          },
          /**
           * Defined by the API payload data.
           *
           * @type {Array<Object>|undefined}
           */
          apiPayload: {
            type: Array,
            computed: '_computeApiPayload(_methodModel)'
          },
          /**
           * Computed value if the method can carry a payload.
           */
          isPayloadRequest: {
            type: Boolean,
            value: false,
            computed: '_computeIsPayloadRequest(httpMethod)',
            observer: '_isPayloadChanged'
          },
          /**
           * OAuth2 redirect URI.
           * This value **must** be set in order for OAuth 1/2 to work properly.
           */
          redirectUri: String,
          /**
           * Inheritet from the authorization panel state if authorization is
           * required. Authorization may be not required if one of the
           * authorization methods is `nil` (RAML).
           */
          authRequired: Boolean,
          /**
           * Inheritet from the authorization panel state if authorization
           * data is valid.
           */
          authValid: Boolean,
          /**
           * If set it will renders the view in the narrow layout.
           */
          narrow: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true
          },
          /**
           * Computed value of if authorization is required for the endpoint.
           * If the auth is not required then the authorization tab is removed
           * from the view.
           */
          authNotRequired: {
            type: Boolean,
            computed: '_computeNoAuth(securedBy)',
            observer: '_noAuthChanged'
          },
          /**
           * Flag set when the request is being made.
           */
          loadingRequest: {
            type: Boolean,
            notify: true,
            value: false
          },
          /**
           * If set it computes `hasOptional` property and shows checkbox in the
           * form to show / hide optional properties.
           */
          allowHideOptional: Boolean,
          /**
           * If set, enable / disable param checkbox is rendered next to each
           * form item.
           */
          allowDisableParams: Boolean,
          /**
           * When set, renders "add custom" item button.
           * If the element is to be used withouth AMF model this should always
           * be enabled. Otherwise users won't be able to add a parameter.
           */
          allowCustom: Boolean,
          // Selected by the user auth method (if any)
          authMethod: String,
          // Current authorization settings.
          authSettings: Object,
          /**
           * Generated request ID when the request is sent. This value is reported
           * in send and abort events
           */
          requestId: String
        };
      }
      /**
       * @constructor
       */
      constructor() {
        super();
        super._authSettingsChanged = this._authSettingsChanged.bind(this);
        this._responseHandler = this._responseHandler.bind(this);
        this._authRedirectChangedHandler = this._authRedirectChangedHandler.bind(this);
      }

      _attachListeners(node) {
        this.addEventListener('authorization-settings-changed', super._authSettingsChanged);
        node.addEventListener('api-response', this._responseHandler);
        node.addEventListener('oauth2-redirect-uri-changed', this._authRedirectChangedHandler);
      }

      _detachListeners(node) {
        this.removeEventListener('authorization-settings-changed', super._authSettingsChanged);
        node.removeEventListener('api-response', this._responseHandler);
        node.removeEventListener('oauth2-redirect-uri-changed', this._authRedirectChangedHandler);
      }
      /**
       * Clears the request properties.
       */
      clearRequest() {
        this.set('url', '');
        this.set('headers', '');
        this.set('payload', '');
        this.set('method', 'GET');
        this.shadowRoot.querySelector('authorization-panel').clear();
        this.selectedTab = 0;
      }
      /**
       * Computes base URI passed to the URL editor.
       *
       * @param {String} apiBaseUri Computed from AMF base uri
       * @param {?String} customBaseUri Base URI that overrides api base uri
       * @return {String} `customBaseUri` if present or `apiBaseUri`
       */
      _computeFinalBaseUri(apiBaseUri, customBaseUri) {
        if (customBaseUri) {
          return customBaseUri;
        }
        return apiBaseUri;
      }
      /**
       * Computes method model from the AMF model
       *
       * @param {Array|Object} api The AMF model for the API.
       * @param {String} id Method `@id` property value
       * @return {Object|undefined} Method definition for an id.
       */
      _computeMethodModel(api, id) {
        if (!id || !api) {
          return;
        }
        const endpointId = this.computeEndpointId(id);
        const endpoint = this.findEndpoint(endpointId, api);
        if (!endpoint) {
          return;
        }
        if (endpointId === id) {
          return;
        }
        return this.findMethod(id, endpoint[HYD_CORE + 'supportedOperation']);
      }
      /**
       * Computes endpoint `@id` for given `id`.
       * On a base level it subrtacts the last part after `/` which
       * is a delimiter between endpoint identifier and method name.
       *
       * @param {String} id Object ID. Can be operation's or endpoint's ID.
       * @return {String} Endpoint id. It may return the same value if passed
       * id is endpoint ID.
       */
      computeEndpointId(id) {
        if (!id) {
          throw new Error('Argument "id" is required.');
        }
        const parts = id.split('/');
        if (parts[parts.length - 1][0] === '%') {
          return id;
        }
        parts.pop();
        return parts.join('/');
      }
      /**
       * Finds an endpoint definition in the API.
       *
       * @param {String} endpointId Endpoint `@id` from AMF model
       * @param {?Object} api AMD model for the api. If not set, `webApi` property
       * is used.
       * @return {Object|undefined} Definition of the endpoint.
       */
      findEndpoint(endpointId, api) {
        if (api instanceof Array) {
          api = api[0];
        }
        if (!this._modelHasType(api, VOC_DOC + 'Document')) {
          return;
        }
        const encodes = api[VOC_DOC + 'encodes'];
        api = encodes.find((item) => this._modelHasType(item, 'http://schema.org/WebAPI'));
        if (!api) {
          return;
        }
        api = api[VOC_HTTP + 'endpoint'];
        if (!api) {
          return;
        }
        return api.find((item) => item['@id'] === endpointId);
      }
      /**
       * Finds a method definition on the list of operations for an endpoint.
       *
       * @param {String} id ID of the operation (method)
       * @param {Array<Object>} operations List of endpoint's operations.
       * @return {Object|undefined} Method definition.
       */
      findMethod(id, operations) {
        if (!id || !operations || !operations.length) {
          return;
        }
        return operations.find((item) => item['@id'] === id);
      }

      /**
       * Checks if a model has a type.
       * @param {Object} model Model to test
       * @param {String} type Type name
       * @return {Boolean} True if model has a type.
       */
      _modelHasType(model, type) {
        const types = model['@type'] || [];
        const index = types.findIndex((item) => item === type);
        return index !== -1;
      }
      /**
       * Computes AMF model for authorization panel.
       *
       * @param {Object} model Current method model.
       * @return {Array|undefined} List of security definitions for the endpoint.
       */
      _computeSecuredBy(model) {
        return model && model[RAML_VOC + 'security#security'];
      }
      /**
       * Computes model definition for headers.
       *
       * @param {?Object} model Method model
       * @return {Array|undefined} List of headers or undefined.
       */
      _computeHeaders(model) {
        if (!model) {
          return;
        }
        model = model[HYD_CORE + 'expects'];
        if (!model) {
          return;
        }
        model = model[0];
        return model[VOC_HTTP + 'header'];
      }
      /**
       * Computes if authorization for the endpoint is set.
       *
       * @param {Object} model Operation model.
       * @return {Boolean}
       */
      _computeNoAuth(model) {
        return !(model && model[0]);
      }
      /**
       * Computes value for `httpMethod` property from AMF model for current
       * operation.
       *
       * @param {Object} model Operation model.
       * @return {String} Method name.
       */
      _computeHttpMethod(model) {
        const value = model[HYD_CORE + 'method'];
        return value && value[0]['@value'];
      }
      /**
       * Computes value for `apiPayload` property from AMF model for current
       * method.
       *
       * @param {Object} model Operation model.
       * @return {Array<Object>|undefined} Method payload.
       */
      _computeApiPayload(model) {
        if (!model) {
          return;
        }
        model = model[HYD_CORE + 'expects'];
        if (!model) {
          return;
        }
        model = model[0];
        return model[VOC_HTTP + 'payload'];
      }
      /**
       * Computes value for `isPayloadRequest`.
       * Only `GET` and `HEAD` methods are known as ones that can't carry a
       * payload. For any other HTTP method this always returns true.
       *
       * @param {String} method HTTP method value
       * @return {Boolean}
       */
      _computeIsPayloadRequest(method) {
        return ['get', 'head'].indexOf(method) === -1;
      }
      /**
       * Updates tabs selection when `authNotRequired` property change.
       * It changes selection to the next tab if there's no authorization
       * and current selected editor is authorization.
       *
       * @param {Boolean} value Current value for `authNotRequired`
       */
      _noAuthChanged(value) {
        if (!value && this.selectedTab === 2) {
          this.selectedTab = 0;
        } else if (value && this.selectedTab === 0) {
          this.selectedTab = 1;
        }
        this._refreshTabs();
        this._analyticsEvent('no-auth-changed', String(value));
      }
      /**
       * Updates the state of the body editor when switching to it.
       * Code mirror does not property calculate it's value when
       * the editor is not visible. This forces to refresh the value of the
       * editor.
       *
       * @param {Number} selected Selected tam index.
       */
      _selectedTabChanged(selected) {
        if (selected === 3) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            this.shadowRoot.querySelector('api-body-editor').currentPanel.refresh();
          });
        }
        this._analyticsEvent('tab-changed', selected);
      }
      /**
       * Refreshes tabs selection when `isPayloadRequest` peroperty chnage.
       */
      _isPayloadChanged(state) {
        if (!state && this.selectedTab === 3) {
          this.selectedTab = 1;
        }
        this._refreshTabs();
      }
      /**
       * Refreshes tabs selection. To be called when number of tabs changes.
       */
      _refreshTabs() {
        const tabs = this.shadowRoot && this.shadowRoot.querySelector('paper-tabs');
        if (!tabs) {
          return;
        }
        tabs.notifyResize();
      }
      /**
       * Dispatches analytics event.
       * @param {String} action Event action
       * @param {String} label Event label
       */
      _analyticsEvent(action, label) {
        const e = new CustomEvent('send-analytics', {
          detail: {
            type: 'event',
            category: ApiRequestEditor.is,
            action: action,
            label: label
          },
          bubbles: true,
          composed: true
        });
        this.dispatchEvent(e);
      }
      /**
       * To be called when the user want to execute the request but
       * authorization is invalid (missin values).
       * This function brings the auth panel to front and displays error toast
       *
       * TODO: There is a case when the user didn't requested OAuth2 token
       * but provided all the data. This function should check for this
       * condition and call authorization function automatically.
       */
      authAndExecute() {
        this.__requestAuthAwaiting = true;
        if (this.selectedTab !== 0) {
          this.selectedTab = 0;
        }
        this.$.authFormError.opened = true;
      }
      /**
       * Executes the request by dispatching `api-request` custom event.
       * The event must be handled by hosting application to ensure transport.
       * Use `advanced-rest-client/xhr-simple-request` component to add logic
       * that uses XHR as a transport.
       *
       * Hosting application also must reset state of `loadingRequest` property
       * once the response is ready. It also can dispatch `api-response`
       * custom event handled by this element to reset state. This is also
       * handled by `xhr-simple-request` component.
       */
      execute() {
        this.loadingRequest = true;
        const detail = this.serializeRequest();
        this.requestId = this.$.uuid.generate();
        detail.id = this.requestId;
        const e = new CustomEvent('api-request', {
          cancelable: true,
          bubbles: true,
          composed: true,
          detail: detail
        });
        this.dispatchEvent(e);
        this._analyticsEvent('request-execute', 'true');
      }
      /**
       * Sends the `abort-api-request` custom event to cancel the request.
       * Calling this method befor sending request may have unexpected
       * behavior because `requestId` is only set with `execute()` method.
       */
      _abortRequest() {
        this.dispatchEvent(new CustomEvent('abort-api-request', {
          cancelable: true,
          bubbles: true,
          composed: true,
          detail: {
            url: this.url,
            id: this.requestId
          }
        }));
        this._analyticsEvent('request-abort', 'true');
        this.loadingRequest = false;
        this.requestId = undefined;
      }
      /**
       * Returns an object with the request properties.
       * The object contains:
       * - `method` (String)
       * - `url` (String)
       * - `headers` (String)
       * - `payload` (String)
       * - `auth` (Object)
       *
       * The `auth` property is optional and is only added to the request if
       * simple `authorization` header will not work. For example NTLM auth
       * method has to be made on a single socket connection (authorization
       * and the request) so it can't be made before the request.
       *
       * The `auth` object contains 2 properties:
       * - `type` (String) the authorization type - one of from the
       * `auth-methods` element
       * - `settings` (Object) Authorization parameters entered by the user.
       * It vary and depends on selected auth method.
       * For example in case of the NTLM it will be: `username`, `password` and
       * `domain`. See `advanced-rest-client/auth-methods` for model descriptions.
       */
      serializeRequest() {
        const result = {
          method: (this.httpMethod || 'get').toUpperCase(),
          url: this.url,
          headers: this.headers,
          payload: this.payload,
          queryModel: this.queryModel,
          pathModel: this.pathModel,
          headersModel: this.shadowRoot.querySelector('api-headers-editor').viewModel
        };
        if (this.authMethod && this.authSettings) {
          result.auth = this.authSettings;
          result.authType = this.authMethod;
        }
        return result;
      }
      /**
       * Handler for the `authorization-settings-changed` dispatched by
       * authorization panel. Sets auth settings and executes the request if
       * any pending if valid.
       *
       * @param {CustomEvent} e
       */
      _authSettingsChanged(e) {
        this.authMethod = e.detail.type;
        this.authSettings = e.detail.settings;
        if (e.detail.valid && this.__requestAuthAwaiting) {
          this.__requestAuthAwaiting = false;
          this.execute();
        }
      }
      /**
       * Handler for the `api-response` custom event.
       * Clears the loading state.
       */
      _responseHandler(e) {
        if (e.detail.id !== this.requestId) {
          return;
        }
        this.loadingRequest = false;
      }
      /**
       * Handler for the `oauth2-redirect-uri-changed` custom event. Changes
       * the `redirectUri` property.
       * @param {CustomEvent} e
       */
      _authRedirectChangedHandler(e) {
        this.redirectUri = e.detail.value;
      }
      /**
       * Dispatched when the user requests to send current request.
       *
       * This event can be cancelled.
       *
       * @event api-request
       * @param {String} url The request URL. Can be empty string.
       * @param {String} method HTTP method name. Can be empty.
       * @param {String} headers HTTP headers string. Can be empty.
       * @param {String|File|FormData} payload Message body. Can be undefined.
       * @param {?Object} auth Authorization settings from the auth panel.
       * May be `undefined`.
       * @param {?String} authType Name of the authorization methods. One of
       * `advanced-rest-client/auth-methods`.
       * @param {String} id Generated UUID for the request. Each call of
       * `execute()` function regenerates the `id`.
       * @param {?Array<Object>} queryModel Query parameters data view model
       * @param {?Array<Object>} pathModel URI parameters data view model
       * @param {?Array<Object>} headersModel Headers data view model
       */
      /**
       * Fired when the user requests to abort current request.
       *
       * This event can be cancelled.
       *
       * @event abort-api-request
       * @param {String} url The request URL. Can be empty string. Also, it may be
       * different URL that the one used to send the request if the user changed
       * it in between. Use the `id` property to compare requests.
       * @param {String} id Generated UUID of the request with `send-request`
       * event.
       */
    }

    window.customElements.define(ApiRequestEditor.is, ApiRequestEditor);
  })();
  </script>
</dom-module>
